<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge View - Shatalov Graph</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Vis.js Network -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        .vis-network { outline: none; }
        .card-masonry {
            column-count: 1;
        }
        @media (min-width: 768px) { .card-masonry { column-count: 2; } }
        @media (min-width: 1280px) { .card-masonry { column-count: 3; } }
        
        .shatalov-block {
            break-inside: avoid;
            page-break-inside: avoid;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden" x-data="app()">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm z-10">
        <div>
            <h1 class="text-xl font-bold text-slate-900 tracking-tight" x-text="meta.course_title || 'Knowledge Base'"></h1>
            <p class="text-sm text-slate-500" x-text="(meta.domain || 'General') + ' • ' + (concepts.length) + ' concept nodes'"></p>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Search -->
            <div class="relative">
                <input 
                    type="text" 
                    placeholder="Search concepts..." 
                    class="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-64 transition-all"
                    x-model="searchQuery"
                    @input.debounce.300ms="filterGraph()"
                >
                <svg class="w-4 h-4 text-slate-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <!-- View Toggle -->
            <div class="bg-slate-100 p-1 rounded-lg flex text-sm font-medium">
                <button 
                    @click="view = 'graph'" 
                    :class="view === 'graph' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                    class="px-4 py-1.5 rounded-md transition-all">
                    Graph
                </button>
                <button 
                    @click="view = 'cards'" 
                    :class="view === 'cards' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                    class="px-4 py-1.5 rounded-md transition-all">
                    Cards
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden">
        
        <!-- Graph View -->
        <div x-show="view === 'graph'" class="absolute inset-0 bg-slate-50" x-transition.opacity>
            <div id="mynetwork" class="w-full h-full"></div>
            
            <!-- Floating Details Panel -->
            <div x-show="selectedNode" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="translate-x-0 opacity-100"
                 x-transition:leave-end="translate-x-full opacity-0"
                 class="absolute right-0 top-0 bottom-0 w-96 bg-white border-l border-slate-200 shadow-xl overflow-y-auto p-6 z-20"
                 x-cloak>
                
                <div class="flex justify-between items-start mb-4">
                    <span 
                        class="px-2 py-1 rounded text-xs font-semibold uppercase tracking-wider"
                        :class="typeColors[selectedNode?.type] || 'bg-slate-100 text-slate-600'"
                        x-text="selectedNode?.type">
                    </span>
                    <button @click="deselectNode()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <h2 class="text-2xl font-bold text-slate-900 mb-2" x-text="selectedNode?.label"></h2>
                
                <div x-show="selectedNode?.def" class="text-slate-600 mb-6 leading-relaxed" x-text="selectedNode?.def"></div>

                <!-- Related Skeleton Cards -->
                <template x-if="selectedNode?.cards.length > 0">
                    <div class="mb-6">
                        <h3 class="text-sm font-bold text-slate-900 uppercase tracking-widest mb-3">Found in Cards</h3>
                        <div class="space-y-2">
                            <template x-for="cardId in selectedNode.cards">
                                <button 
                                    @click="selectCard(cardId); view = 'cards'"
                                    class="w-full text-left px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded text-sm transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                    <span x-text="getCardTitle(cardId)"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Relations -->
                <div x-show="selectedNode?.relations.length > 0">
                    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-widest mb-3">Direct Links</h3>
                    <ul class="space-y-3">
                        <template x-for="rel in selectedNode.relations">
                            <li class="flex items-start gap-2 text-sm">
                                <span class="text-slate-400 mt-0.5">•</span>
                                <div>
                                    <span class="font-medium text-slate-700" x-text="rel.type.replace('_', ' ')"></span>
                                    <span class="text-slate-400 px-1">→</span>
                                    <button @click="focusNode(rel.targetId)" class="text-blue-600 hover:underline" x-text="rel.targetLabel"></button>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Cards View -->
        <div x-show="view === 'cards'" class="absolute inset-0 bg-slate-100 overflow-y-auto p-6" x-transition.opacity>
            <div class="max-w-7xl mx-auto card-masonry gap-6 space-y-6">
                
                <template x-for="card in skeleton_cards" :key="card.card_id">
                    <div 
                        :id="'card-' + card.card_id"
                        class="shatalov-block bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow duration-200"
                        :class="{'ring-2 ring-blue-500': highlightedCard === card.card_id}">
                        
                        <!-- Header -->
                        <div class="bg-slate-50 border-b border-slate-100 px-5 py-4">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg text-slate-800" x-text="card.topic"></h3>
                                <span class="text-xs font-mono text-slate-400" x-text="card.blocks.length + ' blocks'"></span>
                            </div>
                        </div>

                        <!-- Blocks -->
                        <div class="divide-y divide-slate-100">
                            <template x-for="(block, idx) in card.blocks" :key="block.block_id">
                                <div class="px-5 py-4 group hover:bg-slate-50 transition-colors">
                                    <div class="flex items-baseline justify-between mb-2">
                                        <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide" x-text="'Block ' + (idx+1) + ': ' + block.title"></h4>
                                    </div>

                                    <!-- Anchors -->
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <template x-for="anchor in block.anchors">
                                            <span 
                                                class="px-2.5 py-1 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded text-sm font-medium"
                                                x-text="anchor">
                                            </span>
                                        </template>
                                    </div>

                                    <!-- Seeds Expansion -->
                                    <div x-data="{ expanded: false }">
                                        <button 
                                            @click="expanded = !expanded"
                                            class="text-xs text-slate-400 hover:text-blue-600 flex items-center gap-1 transition-colors">
                                            <span x-text="expanded ? 'Hide Details' : 'Show Details'"></span>
                                            <svg class="w-3 h-3 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        </button>

                                        <div x-show="expanded" x-collapse class="mt-3 space-y-2 text-sm text-slate-600 pl-3 border-l-2 border-slate-200">
                                            <template x-if="block.seed_pack.rule_plus_conditions">
                                                <p><strong class="text-slate-800">Rule:</strong> <span x-text="block.seed_pack.rule_plus_conditions"></span></p>
                                            </template>
                                            
                                            <template x-if="block.seed_pack.one_strong_example">
                                                <p><strong class="text-slate-800">Ex:</strong> <span x-text="block.seed_pack.one_strong_example"></span></p>
                                            </template>
                                            
                                            <template x-if="block.seed_pack.one_common_mistake">
                                                <div class="flex gap-2 text-amber-700 bg-amber-50 p-2 rounded items-start mt-2">
                                                    <svg class="w-4 h-4 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                                    <span x-text="block.seed_pack.one_common_mistake"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

            </div>
        </div>

    </main>

    <!-- Data Injection Script -->
    <script>
        // Placeholder - will be replaced by Python script
        const DATA = {{DATA_PLACEHOLDER}};
    </script>

    <script>
        function app() {
            return {
                view: 'graph', // 'graph' or 'cards'
                searchQuery: '',
                selectedNode: null,
                highlightedCard: null,
                
                meta: DATA.meta,
                concepts: DATA.concepts,
                relations: DATA.relations_graph,
                skeleton_cards: DATA.skeleton_cards,
                
                network: null,
                nodes: new vis.DataSet([]),
                edges: new vis.DataSet([]),
                
                typeColors: {
                    'concept': 'bg-blue-100 text-blue-700',
                    'method': 'bg-green-100 text-green-700',
                    'mistake': 'bg-red-100 text-red-700',
                    'tool': 'bg-purple-100 text-purple-700',
                    'importance': 'bg-amber-100 text-amber-700'
                },

                init() {
                    this.initGraph();
                    this.processGraphData();
                },

                initGraph() {
                    const container = document.getElementById('mynetwork');
                    const options = {
                        nodes: {
                            shape: 'dot',
                            size: 20,
                            font: { size: 14, face: 'Inter, sans-serif' },
                            borderWidth: 2,
                            shadow: true
                        },
                        edges: {
                            width: 2,
                            smooth: { type: 'continuous' },
                            arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                            color: { color: '#cbd5e1', highlight: '#3b82f6' }
                        },
                        physics: {
                            stabilization: false,
                            barnesHut: { gravitationalConstant: -3000, springConstant: 0.04, springLength: 150 }
                        },
                        interaction: { hover: true, tooltipDelay: 200 }
                    };
                    
                    this.network = new vis.Network(container, { nodes: this.nodes, edges: this.edges }, options);
                    
                    this.network.on("click", (params) => {
                        if (params.nodes.length > 0) {
                            this.selectNode(params.nodes[0]);
                        } else {
                            this.deselectNode();
                        }
                    });
                },

                processGraphData() {
                    // Nodes
                    const visNodes = this.concepts.map(c => {
                        const type = (c.tags && c.tags[0]) || 'concept';
                        let color = '#3b82f6'; // blue default
                        if (type === 'method') color = '#22c55e';
                        if (type === 'mistake' || type === 'pitfall') color = '#ef4444';
                        if (type === 'tool') color = '#a855f7';
                        
                        return {
                            id: c.concept_id,
                            label: c.name,
                            title: c.short_def || c.name,
                            color: { background: '#ffffff', border: color },
                            group: type
                        };
                    });
                    this.nodes.add(visNodes);

                    // Edges
                    const visEdges = this.relations.map(r => ({
                        from: r.from,
                        to: r.to,
                        label: r.type,
                        font: { align: 'middle', size: 10, color: '#94a3b8' },
                        dashes: r.type === 'contrasts_with'
                    }));
                    this.edges.add(visEdges);
                },

                selectNode(nodeId) {
                    const concept = this.concepts.find(c => c.concept_id === nodeId);
                    if (!concept) return;

                    // Find related cards
                    const relatedCards = this.skeleton_cards
                        .filter(card => card.blocks.some(b => b.concept_refs.includes(nodeId)))
                        .map(c => c.card_id);

                    // Find relations
                    const relations = this.relations.filter(r => r.from === nodeId || r.to === nodeId).map(r => {
                        const targetId = r.from === nodeId ? r.to : r.from;
                        const targetConcept = this.concepts.find(c => c.concept_id === targetId);
                        return {
                            type: r.type,
                            targetId: targetId,
                            targetLabel: targetConcept ? targetConcept.name : targetId,
                            direction: r.from === nodeId ? 'out' : 'in'
                        };
                    });

                    this.selectedNode = {
                        id: concept.concept_id,
                        label: concept.name,
                        def: concept.short_def,
                        type: (concept.tags && concept.tags[0]) || 'concept',
                        cards: relatedCards,
                        relations: relations
                    };
                },

                deselectNode() {
                    this.selectedNode = null;
                    this.network.unselectAll();
                },

                focusNode(nodeId) {
                    this.network.selectNodes([nodeId]);
                    this.network.focus(nodeId, { scale: 1.2, animation: true });
                    this.selectNode(nodeId);
                },

                getCardTitle(cardId) {
                    const card = this.skeleton_cards.find(c => c.card_id === cardId);
                    return card ? card.topic : cardId;
                },

                selectCard(cardId) {
                    this.highlightedCard = cardId;
                    setTimeout(() => {
                        const el = document.getElementById('card-' + cardId);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                },

                filterGraph() {
                    const q = this.searchQuery.toLowerCase();
                    if (!q) {
                        this.nodes.update(this.nodes.get().map(n => ({ hidden: false })));
                        return;
                    }
                    
                    const matches = this.nodes.get().filter(n => n.label.toLowerCase().includes(q));
                    const matchIds = matches.map(n => n.id);
                    
                    this.nodes.update(this.nodes.get().map(n => ({
                        hidden: !matchIds.includes(n.id)
                    })));
                    
                    if (matchIds.length > 0) {
                        this.network.fit({ nodes: matchIds, animation: true });
                    }
                }
            }
        }
    </script>
</body>
</html>
